name: Sync Releases from Source

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_REPO: "ReiAccept/MiPay4XiaomiEU"
        run: |
          # 1. 获取源仓库最新的 Release Tag
          latest_tag=$(gh release list -R "$SOURCE_REPO" --limit 1 --json tagName --jq '.[0].tagName')
          
          if [ -z "$latest_tag" ]; then
            echo "未发现源仓库的 Release。"
            exit 0
          fi

          echo "源仓库最新版本为: $latest_tag"

          # 2. 检查本地（镜像仓库）是否已存在该 Tag
          if gh release view "$latest_tag" > /dev/null 2>&1; then
            echo "版本 $latest_tag 已同步，跳过。"
          else
            echo "发现新版本 $latest_tag，准备同步..."

            # 3. 下载源仓库 Release 的所有资产 (Assets)
            mkdir -p ./dist
            gh release download "$latest_tag" -R "$SOURCE_REPO" --dir ./dist

            # 4. 获取源仓库 Release 的标题和正文 (Notes)
            release_title=$(gh release view "$latest_tag" -R "$SOURCE_REPO" --json title --jq '.title')
            gh release view "$latest_tag" -R "$SOURCE_REPO" --json body --jq '.body' > release_notes.md

            # 5. 在当前镜像仓库创建新的 Release 并上传资产
            gh release create "$latest_tag" ./dist/* \
              --title "$release_title" \
              --notes-file release_notes.md
              
            echo "同步完成！"
          fi